<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous"/>
</head>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

<body>

<!-- Vue app starts  -->
<div id="app">

  <Navbar></Navbar>

  <h1 class = "m-5 ">Welcome to Savood {{userNameSession}}!</h1>

  <div class="container mt-5">
    <div>
      <button @click="toggleCurrent" class="btn btn-primary mx-1">Current Order</button>
      <button @click="toggleListing" class="btn btn-success mx-1">Available Orders</button>
      <button @click="toggleHistory" class="btn btn-warning mx-1">Past Orders</button>
    </div>

    <!-- current orders-->
    <div id="toggle" v-show="showCurrent" class="mt-3 mx-auto">
      <!-- {{CurrentOrders}} -->

      <h3>Current Order</h3>

      <h4 v-if="current_message">{{current_message}}</h4>
      <div id="currentDelivery" v-if="CurrentOrders">
        <div class="card d-flex mx-auto mb-3" v-for="order of CurrentOrders">
          <div class="card-header">
            Order#{{order.order_id}}
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col"><h5 class="card-title">PICK UP</h5></div>
              <div class="col"><h5 class="card-title">DROP OFF</h5></div>
              <div class="col" style="text-align: right; color: blue;">
                <h5>{{ order.status }}</h5>
              </div>

    
            <div class="row">
              <div class="col" style="text-align: left;"><h3>{{order.restaurant_name}}</h3></div> 
              <div class="col" style="text-align: left;"><h3>{{order.foodbank_name}}</h3></div> 
              <div class="col" style="text-align: right;">Created at {{order.created_at}}</div> 
            </div>
            
            <div class="row">
              <div class="col"><p class="card-text">{{order.restaurant_address}}</div>
              <div class="col" style="text-align: left;">{{order.foodbank_address}} </div> 
              <div class="col" style="text-align: right;"></div> 
            </div>
            <div class="row">
              <div class="col"><p class="card-text">{{order.restaurant_phone_number}}</p></div>
              <div class="col" style="text-align: left;">{{order.foodbank_phone_number}}</div> 
              <div class="col" id="changeStatus" style="text-align: right;">
                <!-- if current status is accepted, buttons not yet synced to database-->
                <button v-if="order.status === 'delivered'" @click="setDoneOrder(order.order_id)" class="btn btn-primary mx-1">Done</button>
              </div> 
            </div>
          </div>
        </div>
      </div>
      </div>


      <div class="card">
        <div class="card-header">
          Order #12233
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col"><h5 class="card-title">Makanmakan</h5></div>
            <div class="col text-left"><h5>Justin Bieber</h5></div>
            <div class="col text-right text-orange"><h5>Picked Up</h5></div>
          </div>
          <div class="row">
            <div class="col"><p class="card-text">100 Kasai Road</p></div>
            <div class="col text-left">SHC7878J</div>
            <div class="col text-right">Order Created today at 18:10</div>
          </div>
          <div class="row">
            <div class="col"><p class="card-text">298188</p></div>
          </div>
          <div class="row">
            <div class="col"><p class="card-text">+6581234567</p></div>
            <div class="col text-left">+6570351268</div>
          </div>
          <div class="row">
            <div class="col"><p class="card-text">Non-vegetarian Lunchboxes</p></div>
          </div>
        </div>
      </div>
    </div>
    
    <div v-show="showListing" class="mt-3">
      <!-- {{AvailableOrders}} -->
      <h3>Available Orders</h3>
      <div class="card" v-for="availableOrder of AvailableOrders" v-if="AvailableOrders">
        <div class="card-header">
          Order #{{availableOrder.order_id}}
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col"><h5 class="card-title">{{availableOrder.restaurant_name}}</h5></div>
          </div>
          <div class="row">
            <div class="col"><p class="card-text">{{availableOrder.restaurant_address}}</p></div>
            <div class="col text-right">{{availableOrder.created_at}}</div>
          </div>
          <div class="row">
            <div class="col"><p class="card-text">{{availableOrder.restaurant_phone_number}}</p></div>
          </div>
          <div class="row">
            <div class="col"><p class="card-text">{{availableOrder.dish_name}}</p></div>
          </div>
          <div class="row">
            <div class="col text-right">
              <button type="button" class="btn btn-primary" @click="setChosenOrder(availableOrder.order_id)">Place Order</button>
            </div>
          </div>
        </div>
      </div>
      <!-- Display available orders details -->
    </div>

    <div v-show="showHistory" class="mt-3" >
      <h5 v-if="previous_message" class="text-center">{{previous_message}}</h5>
      <!-- Display past orders details -->
      <div v-show="showHistory">
        <h3 class="mt-3">Past Orders</h3>
        <table class="table table-striped border-1" v-if="previous_orders">
          <thead class="table-dark">
            <tr>
              <th>Order ID</th>
              <th>Date</th>
              <th>Restaurant Name</th>
              <th>Dish Name</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="previous_order of previous_orders">
              <td>{{ previous_order.order_id }}</td>
              <td>{{ previous_order.created_at }}</td>
              <td>{{ previous_order.restaurant_name }}</td>
              <td>{{ previous_order.dish_name }}</td>
              <td>{{ previous_order.status }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <Footer></Footer>

</div>
<!-- Vie app ends-->

<script>

  ORDER_API_URL = 'http://127.0.0.1:5005'
  PLACE_ORDER_API_URL = 'http://127.0.0.1:5101'
  
  const app = Vue.createApp({
      data() {
        return {
          userId: null,
          userType: null,
          userNameSession: null,
          showCurrent: true,
          showListing: false,
          showHistory: false,
          orders: null,
          CurrentOrders: null,
          AvailableOrders: null,

          //placeorder
          chosen_order_id: null,

          // current
          currentOrder: null,
          current_message: null,

          //history
          previous_orders: null,
          previous_message: null,

          //mark order as done
          chosen_done_order_id: null

        };
      },
      methods: {
        toggleCurrent() {
          this.showCurrent = true;
          this.showListing = false;
          this.showHistory = false;
          this.fetchCurrentOrders();
        },
        toggleListing() {
          this.showCurrent = false;
          this.showListing = true;
          this.showHistory = false;
          this.fetchAvailableOrders()
        },
        toggleHistory() {
          this.showCurrent = false;
          this.showListing = false;
          this.showHistory = true;
          this.fetchPreviousOrders();
        },
        async setChosenOrder(orderId) {
          this.chosen_order_id = orderId;
          console.log(this.chosen_order_id);
          await this.submitPlaceOrder();
          this.toggleCurrent();
        },

        async setDoneOrder(orderId) {
          this.chosen_done_order_id = orderId;
          console.log(this.chosen_done_order_id);
          await this.submitDoneOrder();
          this.toggleCurrent();
        },

        async fetchPreviousOrders() {
          const serviceURL = `${ORDER_API_URL}/get_previous_orders/${this.userId}`;

          try {
            const response = await fetch(serviceURL, { method: 'GET' });
            const result = await response.json();
    
            if (result.code === 200) {
              this.previous_orders = result.data.orders;
              this.previous_message = null;
              console.log(this.previous_orders)
            } else if (result.code === 404) {
              this.previous_message = result.message;
              this.previous_orders = null;
            } else {
              throw response.status;
            }
          } catch (error) {
            console.log('error')
            this.error = `There is a problem retrieving previous orders data, please try again later.<br />${error}`;
          }
        },

        async fetchCurrentOrders(){
          const serviceURL = `http://127.0.0.1:5005/get_non_pending_or_done_orders/${this.userId}`;

          try {
            const response = await fetch(serviceURL, { method: 'GET' });

            if (response.status === 200) {
              const result = await response.json();
              console.log('status 200');
              this.CurrentOrders = result.orders;
              console.log(this.CurrentOrders);
            } else if (response.status === 404) {
              console.log('error 404');
              console.log(this.error);
            } else {
              throw response.status;
            }
          } catch (error) {
              console.log('error');
              this.error = `There is a problem retrieving non-pending and non-done orders data, please try again later.<br />${error}`;
          }
        },

        async fetchAvailableOrders(){
          const serviceURL = `${PLACE_ORDER_API_URL}/load_orders/${this.userId}`;

          try {
            const response = await fetch(serviceURL, { method: 'GET' });
            console.log(response.status)
            const result = await response.json()
            console.log(result)
            if (result.code === 200) {
              console.log('status 200');
              this.AvailableOrders = result.data;
              console.log(this.AvailableOrders);
              } else if (result.code === 404) {
                console.log('error 404');
                this.error = 'Orders not found';
              } else {
                throw response.status;
              }
          } catch (error) {
              console.log('error');
              this.error = `There is a problem retrieving order data, please try again later.<br />${error}`;
          }
        },

        async submitPlaceOrder() {
          const serviceURL = `${PLACE_ORDER_API_URL}/place_order`;
          try {
            const response = await fetch(serviceURL, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                order_id: this.chosen_order_id,
                foodbank_id: this.userId,
              }),
            });

            result = await response.json();
            console.log(result);
            return Promise.resolve();
          } catch (error) {
            this.message = error.message;
            return Promise.reject(error);
          }
        },

        async submitDoneOrder() {
          const serviceURL = `${ORDER_API_URL}/update_order_status`;
          try {
            const response = await fetch(serviceURL, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                order_id: this.chosen_done_order_id,
                status: 'done'
              }),
            });

            result = await response.json();
            console.log(result);
            return Promise.resolve();
          } catch (error) {
            this.message = error.message;
            return Promise.reject(error);
          }
        }
      },

      created() {
        const saveduserId = localStorage.getItem('userId');
        const saveduserType = localStorage.getItem('userType');
        const saveduserNameSession = localStorage.getItem('userNameSession')
        console.log(saveduserId, saveduserType, saveduserNameSession)
        if (saveduserId) {
            this.userId = parseInt(saveduserId);
        }
        this.userType = saveduserType
        this.userNameSession = saveduserNameSession
        console.log(this.userId, this.userType, this.userNameSession)
        if (!this.userId && this.userType != 'foodbank'){
          window.location.href = './signUp.html'
        }
        this.toggleCurrent();
      }

    });

</script>


<!-- Import the Navbar and Footer components -->
<script src="./UI_COMPONENTS/Navbar.js"></script>
<!-- <script src="../UI_COMPONENTS/Footer.js"></script> -->

<script>app.mount('#app');</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>

</body>
</html>

