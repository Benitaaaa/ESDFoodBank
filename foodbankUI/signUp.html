<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microservice UI</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
    <div id="app">
        <div>
            <div v-if="!userId">
                <h1>Sign up</h1>
                <form @submit.prevent="submitSignUpForm">
                    Email: <input type="email" v-model="user_email" required>
                    <br>
                    Username: <input type="text" v-model="username" required>
                    <br>
                    User type:
                    <br>
                    <input type="radio" id="restaurant" value="restaurant" v-model="user_type" required> <label for="restaurant">Restaurant</label>
                    <br>
                    <input type="radio" id="foodbank" value="foodbank" v-model="user_type" required> <label for="foodbank">Foodbank</label>
                    <br>
                    <input type="radio" id="driver" value="driver" v-model="user_type" required> <label for="driver">Driver</label>
                    <br>

                    Phone Number: <input type="text" v-model="phone_number" required>
                    <br>
                    Region:
                    <br>
                    <input type="radio" value="Central" v-model="region" required> Central
                    <br>
                    <input type="radio" value="North" v-model="region" required> North
                    <br>
                    <input type="radio" value="West" v-model="region" required> West
                    <br>
                    <input type="radio" value="East" v-model="region" required> East
                    <br>
                    <input type="radio" value="North-West" v-model="region" required> North-West
                    <br>

                    <span v-if="notDriver">
                        Postal Code: <input type="number" v-model="postal_code" :required="notDriver">
                        <br>
                        Address: <input type="text" v-model="address" :required="notDriver">
                        <br>
                    </span>

                    
                    <label for="password">Password:</label>
                    <input type="password" v-model="password" required>
                    <br>
                    <button type="submit">Sign up</button>
                </form>
            </div>
            <div v-if="!userId">
                <h1>Sign In</h1>
                <form @submit.prevent="submitLoginForm">
                    <label for="login_email">Email:</label>
                    <input type="text" v-model="login_email" required>
                    <br>
                    <label for="login_password">Password:</label>
                    <input type="password" v-model="login_password" required>
                    <br>
                    <button type="submit">Sign in</button>
                </form>
            </div>
            <p>{{ message }}</p>
            <p v-if="userId">Logged in as: {{ userId }}</p>
            <p v-if="userType">You are a {{ userType }}</p>
            <button v-if="userId" @click="logout">Logout</button>
        </div>
        
    </div>
    
    <script>
        const API_URL = 'http://127.0.0.1:5000';
    
        const app = Vue.createApp({
            data() {
                return {
                    //Sign up stuff
                    user_email: '',
                    username: '',
                    user_type: '',
                    phone_number: '',
                    region: '',
                    postal_code: '',
                    address: '',

                    //Sign in stuff
                    login_email: '',
                    login_password: '',

                    //Verification 
                    userId: '',
                    userType: '',
                    message: ''
                };
            },
            computed: {
                notDriver() {
                    return this.user_type === "restaurant" || this.user_type === "foodbank"
                }
            },
            methods: {
                async submitSignUpForm() {
                    try {
                        const response = await fetch(`${API_URL}/signup`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                user_email: this.user_email,
                                username: this.username,
                                user_type: this.user_type,
                                phone_number: this.phone_number,
                                region: this.region,
                                postal_code: this.postal_code,
                                address: this.address,
                                password: this.password,
                            })
                        });

                        // if (!response.ok) {
                        //     throw new Error('Error during sign up');
                        // }

                        const data = await response.json();
                        this.message = data.message;
                        this.userId = data.user_id;
                        this.userType = data.user_type;
                        localStorage.setItem('userId', data.user_id);
                        localStorage.setItem('userType', data.user_type);
                        window.location.href = './index.html';
                        } catch (error) {
                            this.message = error.message;
                        }
                },

                async submitLoginForm() {
                    try {
                        const response = await fetch(`${API_URL}/login`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                email: this.login_email,
                                password: this.login_password,
                            }),
                            credentials: 'include',
                        });

                        if (!response.ok) {
                            throw new Error('Error during login');
                        }

                        const data = await response.json();
                        this.message = data.message;
                        this.userId = data.user_id;
                        this.userType = data.user_type;
                        localStorage.setItem('userId', data.user_id);
                        localStorage.setItem('userType', data.user_type);
                        window.location.href = './index.html';

                    } catch (error) {
                        this.message = error.message;
                    }
                },

                async logout() {
                    try {
                        const response = await fetch(`${API_URL}/logout`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            credentials: 'include',
                        });

                        if (!response.ok) {
                            throw new Error('Error during logout');
                        }

                        const data = await response.json();
                        this.message = data.message;
                        this.userId = '';
                        this.userType = '';
                        localStorage.removeItem('userId');
                        localStorage.removeItem('userType');
                        window.location.href = './signUp.html';
                    } catch (error) {
                        this.message = error.message;
                    }
                },

            }, 

            created() {
                const saveduserId = localStorage.getItem('userId');
                console.log(saveduserId)
                if (saveduserId) {
                    this.userId = parseInt(saveduserId);
                }
                console.log(this.userId)
            },

        }).mount('#app');
    </script>
    
</body>
</html>
