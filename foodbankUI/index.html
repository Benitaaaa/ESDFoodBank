<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foodbank</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous"/>
</head>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>




<body>


<!-- navbar starts  -->
<div id="app">
  <Navbar></Navbar>

<!-- navbar ends  -->

<h1 class = "m-5 "> Welcome to Savood! </h1>


<div class="container mt-5">

  <div>
    <button @click="toggleCurrent" class="btn btn-primary mx-1">Current Order</button>
    <button @click="toggleListing" class="btn btn-success mx-1">Available Orders</button>
    <button @click="toggleHistory" class="btn btn-warning mx-1">Past Orders</button>

    <!-- Current Delivery -->
    <div id="toggle" class="mt-3 mx-auto" v-show="showCurrent">
      <h3>Current Order</h3>
      <div id="currentOrder">
        <div class="card d-flex mx-auto">
          <div class="card-header">
            Order #12233
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col"><h5 class="card-title">Makanmakan</h5></div>
              <div class="col" style="text-align: left;"><h5>Justin Bieber</h5></div> 
              <div class="col" style="text-align: right; color: orange;"><h5>Picked Up</h5></div> 
            </div>
            <div class="row">
              <div class="col"><p class="card-text">100 Kasai Road</div>
              <div class="col" style="text-align: left;">SHC7878J </div> 
              <div class="col" style="text-align: right;">Order Created today at 18:10</div> 
            </div>
            <div class="row">
              <div class="col"><p class="card-text">298188</div>
              <div class="col" style="text-align: left;"> </div> 
              <div class="col" style="text-align: right;"></div> 
            </div>
            <div class="row">
              <div class="col"><p class="card-text">+6581234567</p></div>
              <div class="col" style="text-align: left;">+6570351268</div> 
              <div class="col" style="text-align: right;"></div> 
            </div>
            <div class="row">
              <div class="col"><p class="card-text">Non-vegetarian Lunchboxes</p></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- View Listing -->
    <div id="toggle" class="mt-3" v-show="showListing">
      <h3>Available Orders</h3>
      <div id = "cardContainer">
        
      </div>
      
      
    </div>
    
    <!-- History -->
    <div id="toggle" class="mt-3" v-show="showHistory">
      <div id="main-container" class="container">
        <h3>Past Orders</h3>
        <table class='table table-striped border-1'>
            <thead class='table-dark'>
                <tr>
                    <th>Order ID</th>
                    <th>Date</th>
                    <th>Restaurant Name</th>
                    <th>Dish Name</th>
                    <th>Status</th>
                    
                </tr>
            </thead>
          <tbody id="orderTable"></tbody>
         
      </table>
        <!-- <a id="addBookBtn" class="btn btn-primary" 
      href="add-book.html">Add a book</a> -->
      </div>
    </div>

  </div>
</div>

  <!-- Footer -->
<div class="container">
  <footer class="row row-cols-1 row-cols-sm-2 row-cols-md-5 py-5 my-5 border-top">
    <div class="col mb-3">
      <a href="/" class="d-flex align-items-center mb-3 link-dark text-decoration-none">
        <svg class="bi me-2" width="40" height="32"><use xlink:href="#bootstrap"></use></svg>
      </a>
      <p class="text-muted">Â© 2022</p>
    </div>

    <div class="col mb-3">

    </div>

    <div class="col mb-3">
      <h5>Section</h5>
      <ul class="nav flex-column">
        <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-muted">Home</a></li>
        <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-muted">Features</a></li>
        <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-muted">Pricing</a></li>
        <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-muted">FAQs</a></li>
        <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-muted">About</a></li>
      </ul>
    </div>

    <div class="col mb-3">
      <h5>Section</h5>
      <ul class="nav flex-column">
        <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-muted">Home</a></li>
        <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-muted">Features</a></li>
        <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-muted">Pricing</a></li>
        <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-muted">FAQs</a></li>
        <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-muted">About</a></li>
      </ul>
    </div>

    <div class="col mb-3">
      <h5>Section</h5>
      <ul class="nav flex-column">
        <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-muted">Home</a></li>
        <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-muted">Features</a></li>
        <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-muted">Pricing</a></li>
        <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-muted">FAQs</a></li>
        <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-muted">About</a></li>
      </ul>
    </div>
  </footer>
</div>
</div>





</body>
<script>
  ORDER_API_URL = 'http://127.0.0.1:5005'
  const app = Vue.createApp({
      data() {
        return {
          userId: null,
          userType: null,
          showCurrent: true,
          showListing: false,
          showHistory: false,
        };
      },
      methods: {
        toggleCurrent() {
          this.showCurrent = true;
          this.showListing = false;
          this.showHistory = false;
        },
        toggleListing() {
          this.showCurrent = false;
          this.showListing = true;
          this.showHistory = false;
        },
        toggleHistory() {
          this.showCurrent = false;
          this.showListing = false;
          this.showHistory = true;
        },
        async loadListings() {
        //   try {
        //     const response = await fetch("${ORDER_API_URL}/get_order/<region>", {
        //         method: 'POST',
        //         headers: {
        //             'Content-Type': 'application/json'
        //         },
        //         body: JSON.stringify({
        //             user_email: this.user_email,
        //             username: this.username,
        //             user_type: this.user_type,
        //             phone_number: this.phone_number,
        //             region: this.region,
        //             postal_code: this.postal_code,
        //             address: this.address,
        //             password: this.password,
        //         })
        //     });
        // }
        },

      created() {
        const saveduserId = localStorage.getItem('userId');
        const saveduserType = localStorage.getItem('userType');
        const saveduserNameSession = localStorage.getItem('userNameSession')
        console.log(saveduserId, saveduserType)
        if (saveduserId) {
            this.userId = parseInt(saveduserId);
        }
        this.userType = saveduserType
        this.userNameSession = saveduserNameSession
        console.log(this.userId, this.userType)
      }
    }});
  </script>

  
  <script>


    

    // Helper function to display error message
    function showError(message) {
        // Hide the table and button in the event of error
        $('#orderTable').hide();
        $('#cardContainer').hide()

        // Display an error under the main container
        $('#main-container')
            .append("<label>"+message+"</label>");
    }

    //Get Foodbank_id
    const foodbank_id = localStorage.getItem('userId');

        // Check if foodbank_id exists
        if (foodbank_id) {
            console.log("Foodbank ID:", foodbank_id);

            // Use foodbank_id for your purpose
        } 
        else {
            console.log("Foodbank ID not found");
        }

    




    //Display Past Orders
    $(async() => {           
        // Change serviceURL to your own 
        var serviceURL = "http://127.0.0.1:5005/get_previous_orders/" + this.foodbank_id;

        try {
            const response =
             await fetch(
               serviceURL, { method: 'GET' }
            );
            const result = await response.json();
             if (response.status === 200) {
                // success case
                var order = result.data.orders; //the array is in books within data of 
                                               // the returned result
                // for loop to setup all table rows with obtained book data
                var rows = "";
                for (const orders of order) {
                   eachRow ="<td>" + orders.order_id + "</td>" +
                            "<td>" + orders.created_at + "</td>" +
                            "<td>" + orders.restaurant_name + "</td>" +
                            "<td>" + orders.dish_name + "</td>"+
                            "<td>" + orders.status + "</td>";

                   rows += "<tr>" + eachRow + "</tr>";
                }
                    // add all the rows to the table
                    $('#orderTable').append(rows);
                } else if (response.status == 404) {
                    // No books
                    showError(result.message);
                } else {
                    // unexpected outcome, throw the error
                    throw response.status;
                }
            } catch (error) {
                // Errors when calling the service; such as network error, 
                // service offline, etc
                showError
                  ('There is a problem retrieving previous orders data, please try again later.<br />' + error);
            } // error
       });
       
    //Display Current Delivery



    // Get FoodBank Region
    const foodbanksApiBaseUrl = "http://127.0.0.1:5002";
    const foodbanksApiUrl = `${foodbanksApiBaseUrl}/get_foodbank/${foodbank_id}`;

    // Fetch foodbank data
    fetch(foodbanksApiUrl)
      .then(response => response.json())
      .then(data => {
        const foodbankRegion = data.region;
        console.log("Foodbank Region:", foodbankRegion);

        // Use foodbankRegion to create get_order_URL
        const orderManagement_URL = "http://127.0.0.1:5005";
        const get_order_URL = `${orderManagement_URL}/get_order/${foodbankRegion}?status=pending`;
        console.log("Get Order URL:", get_order_URL);

        // Display Available orders
        (async() => {
          try {
            const response = await fetch(get_order_URL, { method: 'GET' });
            const result = await response.json();
                  if (response.status === 200) {            // success case
                    var order = result.data.orders;
                    // for loop to setup all table rows with obtained order data
                    var eachCardrow = "";
                    var counter = 0;
                    for (const orders of order) {
                        if (counter % 3 == 0) {
                            eachCardrow += "<div class='row row-cols-1 row-cols-md-3 g-4 mx-auto'>";
                        }

                        eachCard = `<div class='col'>
                                      <div class = 'card h-100'>
                                        <div class = 'card-body'>
                                          <h3 class= 'card-title'>` + orders.restaurant_name + `</h3>
                                          <p class= 'card-text'>` + orders.restaurant_address + `</p>
                                          <p class= 'card-text'>` + orders.restaurant_phone_number + `</p>
                                          <p class= 'card-text'>` + orders.dish_name + `</p>
                                          <div class= 'mx-auto d-flex col-6'>
                                            <button type="button" class="btn btn-dark mx-auto"> Order </button>
                                          </div>
                                        </div>
                                        <div class = "card-footer">
                                            <small class = 'text-muted'> Created on:` + orders.created_at + `
                                        </div>
                                      </div>
                                    </div>`

                        counter += 1;
                        eachCardrow += eachCard;

                        if (counter % 3 == 0) {
                            eachCardrow += "</div>";
                        }
                    }
                    // add all the rows to the table
                    $('#cardContainer').append(eachCardrow);
                } 
                else if (response.status == 404) {
                    // No orders
                    showError(result.message);
                } 
                else {
                    // unexpected outcome,
                    // throw the error
                  throw response.status;
                }
              } 
              
              catch (error) {
              // Errors when calling the service; such as network error,
              // service offline, etc
                showError(
                  'There is a problem retrieving available orders data, please try again later.<br />' + error
                );
              }
            });

        })
        .catch(error => {
            console.error("Error fetching foodbank region:", error);
        });


    


      </script>


  


  <script src="../UI_COMPONENTS/Navbar.js"></script>

  <script>app.mount('#app');</script>



  

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>

</html>

